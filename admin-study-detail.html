<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 학습 상세 - 이온토플 관리자</title>
    
    <!-- Pretendard Font -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin.css">

    <style>
        /* ===== 요약 카드 영역 ===== */
        .detail-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        @media (max-width: 1024px) {
            .detail-stats-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 640px) {
            .detail-stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .detail-stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        .detail-stat-card .stat-icon {
            width: 44px; height: 44px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 12px; font-size: 18px;
        }
        .detail-stat-card .stat-value {
            font-size: 28px; font-weight: 800; color: #1e293b; line-height: 1;
        }
        .detail-stat-card .stat-label {
            font-size: 12px; color: #94a3b8; margin-top: 6px; font-weight: 500;
        }
        .detail-stat-card .stat-sub {
            font-size: 11px; color: #64748b; margin-top: 4px;
        }

        /* ===== 학생 프로필 헤더 ===== */
        .student-profile-header {
            display: flex; align-items: center; gap: 16px;
            background: white; border-radius: 12px; padding: 20px 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }
        .student-profile-header .avatar {
            width: 56px; height: 56px; border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed, #a78bfa);
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 22px; font-weight: 700; flex-shrink: 0;
        }
        .student-profile-header .info { flex: 1; }
        .student-profile-header .info h2 {
            font-size: 20px; font-weight: 700; color: #1e293b; margin: 0 0 4px;
        }
        .student-profile-header .info .meta {
            font-size: 13px; color: #64748b; display: flex; gap: 16px; flex-wrap: wrap;
        }
        .student-profile-header .actions {
            display: flex; gap: 8px; flex-shrink: 0;
        }
        .btn-back {
            background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0;
            padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px;
            font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 6px;
        }
        .btn-back:hover { background: #e2e8f0; }
        .btn-primary-sm {
            background: #7c3aed; color: white; border: none;
            padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px;
            font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 6px;
        }
        .btn-primary-sm:hover { background: #6d28d9; }

        /* ===== 잔디심기 ===== */
        .grass-container {
            background: white; border-radius: 12px; padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }
        .section-title {
            font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 16px;
            display: flex; align-items: center; gap: 8px;
        }
        .grass-legend {
            display: flex; gap: 16px; margin-bottom: 16px; font-size: 12px; color: #64748b;
            flex-wrap: wrap;
        }
        .grass-legend span { display: flex; align-items: center; gap: 4px; }

        .grass-week-row {
            display: flex; align-items: center; gap: 8px; margin-bottom: 10px;
        }
        .grass-week-label {
            width: 60px; font-size: 13px; font-weight: 600; color: #475569; flex-shrink: 0;
        }
        .grass-cells {
            display: flex; gap: 6px;
        }
        .grass-cell {
            width: 36px; height: 36px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 600; cursor: default;
            position: relative;
        }
        .grass-cell[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 4px 8px; border-radius: 4px;
            font-size: 11px; white-space: nowrap; z-index: 10;
        }
        .grass-done { background: #22c55e; color: white; }
        .grass-partial { background: #fbbf24; color: #78350f; }
        .grass-missed { background: #ef4444; color: white; }
        .grass-pending { background: #f1f5f9; color: #cbd5e1; border: 1px dashed #e2e8f0; }
        .grass-day-labels {
            display: flex; gap: 6px; margin-left: 68px; margin-bottom: 8px;
        }
        .grass-day-label {
            width: 36px; font-size: 10px; color: #94a3b8; text-align: center;
        }

        /* ===== 과제 상세 테이블 ===== */
        .task-table-container {
            background: white; border-radius: 12px; padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid #e2e8f0;
            margin-bottom: 24px; overflow-x: auto;
        }
        .task-table-title {
            font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 16px;
            display: flex; align-items: center; justify-content: space-between; gap: 8px;
        }
        .task-filter-bar {
            display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;
        }
        .task-filter-bar select {
            padding: 6px 12px; border: 1px solid #e2e8f0; border-radius: 6px;
            font-size: 13px; color: #475569; background: white;
        }

        /* ===== 오답노트 섹션 ===== */
        .notes-container {
            background: white; border-radius: 12px; padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }
        .note-card {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;
            padding: 16px; margin-bottom: 12px;
        }
        .note-card-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 8px;
        }
        .note-card-meta {
            font-size: 12px; color: #64748b;
        }
        .note-card-tags { display: flex; gap: 6px; }
        .note-card-tags .tag {
            padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;
        }
        .tag-fraud { background: #fef2f2; color: #ef4444; }
        .tag-short { background: #fffbeb; color: #d97706; }
        .note-card-body {
            font-size: 14px; color: #334155; line-height: 1.6;
            max-height: 100px; overflow: hidden;
            white-space: pre-wrap; word-break: break-word;
        }
        .note-card-body.expanded { max-height: none; }
        .note-toggle {
            font-size: 12px; color: #7c3aed; cursor: pointer; margin-top: 6px;
            font-weight: 600; border: none; background: none; padding: 0;
        }

        /* ===== 과제 진행상태 관리 ===== */
        .progress-mgmt-container {
            background: white; border-radius: 12px; padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }
        .progress-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .progress-table th {
            background: #f8fafc; padding: 10px 12px; text-align: left;
            font-weight: 600; color: #64748b; border-bottom: 2px solid #e2e8f0; font-size: 12px;
        }
        .progress-table td {
            padding: 10px 12px; border-bottom: 1px solid #f1f5f9; color: #334155; vertical-align: middle;
        }
        .progress-table tr:hover { background: #f8fafc; }
        .progress-table tr.clickable { cursor: pointer; }
        .status-badge {
            display: inline-block; padding: 3px 10px; border-radius: 12px;
            font-size: 11px; font-weight: 600;
        }
        .status-in_progress { background: #dcfce7; color: #16a34a; }
        .status-completed { background: #dbeafe; color: #2563eb; }
        .status-abandoned { background: #fef9c3; color: #ca8a04; }
        .btn-restore {
            background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0;
            padding: 4px 10px; border-radius: 6px; cursor: pointer;
            font-size: 11px; font-weight: 600;
        }
        .btn-restore:hover { background: #dcfce7; }
        .btn-delete-progress {
            background: #fef2f2; color: #dc2626; border: 1px solid #fecaca;
            padding: 4px 10px; border-radius: 6px; cursor: pointer;
            font-size: 11px; font-weight: 600;
        }
        .btn-delete-progress:hover { background: #fee2e2; }
        .progress-detail-panel {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;
            padding: 16px; margin: 4px 0 8px 0; font-size: 13px; line-height: 1.8;
        }
        .component-item {
            display: flex; align-items: center; gap: 8px; padding: 4px 0;
        }
        .component-icon { font-size: 14px; width: 20px; text-align: center; }
        .component-name { color: #334155; }
        .component-score { color: #64748b; font-size: 12px; }
        .component-current {
            background: #fef3c7; padding: 2px 8px; border-radius: 4px;
            font-size: 11px; color: #d97706; font-weight: 600;
        }

        /* ===== 주간체크 데이터 수집 ===== */
        .weekly-check-container {
            background: white; border-radius: 12px; padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }
        .copy-area {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;
            padding: 16px; font-family: 'Pretendard', monospace; font-size: 13px;
            line-height: 1.8; color: #334155; white-space: pre-wrap; word-break: break-word;
            max-height: 400px; overflow-y: auto;
        }
        .btn-copy {
            background: #7c3aed; color: white; border: none;
            padding: 8px 20px; border-radius: 8px; cursor: pointer;
            font-size: 13px; font-weight: 600; margin-top: 12px;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .btn-copy:hover { background: #6d28d9; }
        .btn-copy.copied { background: #22c55e; }

        /* ===== 오답노트 모달 ===== */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white; border-radius: 16px; padding: 28px;
            max-width: 640px; width: 90%; max-height: 80vh; overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .modal-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 16px;
        }
        .modal-header h3 { font-size: 18px; font-weight: 700; color: #1e293b; margin: 0; }
        .modal-close {
            background: none; border: none; font-size: 20px;
            color: #94a3b8; cursor: pointer; padding: 4px;
        }
        .modal-close:hover { color: #475569; }
        .modal-body {
            font-size: 14px; color: #334155; line-height: 1.8;
            white-space: pre-wrap; word-break: break-word;
        }
        .modal-meta {
            font-size: 12px; color: #94a3b8; margin-top: 16px; padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }

        @media (max-width: 768px) {
            .student-profile-header { flex-direction: column; text-align: center; }
            .student-profile-header .info .meta { justify-content: center; }
            .student-profile-header .actions { justify-content: center; }
            .grass-day-labels { margin-left: 68px; }
        }
    </style>
</head>
<body>
    <!-- Admin Navigation -->
    <nav class="admin-nav">
        <div class="container">
            <div class="admin-nav-brand">
                <i class="fas fa-shield-alt"></i>
                <span>이온토플 관리자</span>
            </div>
            <div class="admin-nav-menu">
                <a href="admin-dashboard.html" class="admin-nav-link">
                    <i class="fas fa-home"></i> 대시보드
                </a>
                <a href="admin-applications.html" class="admin-nav-link">
                    <i class="fas fa-clipboard-list"></i> 신청서 관리
                </a>
                <a href="admin-study.html" class="admin-nav-link active">
                    <i class="fas fa-book-reader"></i> 학습 관리
                </a>
                <a href="admin-questions.html" class="admin-nav-link">
                    <i class="fas fa-puzzle-piece"></i> 문제 관리
                </a>
                <a href="admin-users.html" class="admin-nav-link">
                    <i class="fas fa-users"></i> 회원 관리
                </a>
                <a href="admin-settings.html" class="admin-nav-link">
                    <i class="fas fa-cog"></i> 사이트 설정
                </a>
                <a href="index.html" class="admin-nav-link">
                    <i class="fas fa-globe"></i> 사이트로
                </a>
                <div class="admin-nav-user" id="adminUser">
                    <i class="fas fa-user-circle"></i>
                    <span id="adminName">관리자</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="admin-container">
        <!-- Loading State -->
        <div class="admin-loading" id="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>학습 데이터를 불러오는 중...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" style="display:none; text-align:center; padding:60px 20px; color:#ef4444;">
            <i class="fas fa-exclamation-triangle" style="font-size:48px; margin-bottom:16px;"></i>
            <p id="errorMsg" style="font-size:16px;">학생 정보를 불러올 수 없습니다.</p>
            <a href="admin-study.html" class="btn-back" style="margin-top:16px;">
                <i class="fas fa-arrow-left"></i> 학습 관리로 돌아가기
            </a>
        </div>

        <!-- Detail Content (hidden until loaded) -->
        <div id="detailContent" style="display:none;">

            <!-- 학생 프로필 헤더 -->
            <div class="student-profile-header">
                <div class="avatar" id="studentAvatar">-</div>
                <div class="info">
                    <h2 id="studentName">-</h2>
                    <div class="meta">
                        <span><i class="fas fa-laptop-code"></i> <span id="studentProgram">-</span></span>
                        <span><i class="fas fa-calendar-alt"></i> <span id="studentPeriod">-</span></span>
                        <span><i class="fas fa-envelope"></i> <span id="studentEmail">-</span></span>
                    </div>
                </div>
                <div class="actions">
                    <a href="admin-study.html" class="btn-back">
                        <i class="fas fa-arrow-left"></i> 목록
                    </a>
                    <button class="btn-primary-sm" id="btnManageApp" style="display:none;">
                        <i class="fas fa-cog"></i> 신청서 관리
                    </button>
                </div>
            </div>

            <!-- 요약 카드 4개 (테스트룸 마이페이지와 동일) -->
            <div class="detail-stats-grid" id="summaryCards">
                <!-- JS에서 렌더링 -->
            </div>

            <!-- 주차별 잔디심기 -->
            <div class="grass-container">
                <div class="section-title">
                    <i class="fas fa-seedling" style="color:#22c55e;"></i>
                    주차별 잔디심기
                </div>
                <div class="grass-legend">
                    <span><span style="display:inline-block;width:14px;height:14px;background:#22c55e;border-radius:3px;"></span> 완료 (4과제+)</span>
                    <span><span style="display:inline-block;width:14px;height:14px;background:#fbbf24;border-radius:3px;"></span> 부분 제출</span>
                    <span><span style="display:inline-block;width:14px;height:14px;background:#ef4444;border-radius:3px;"></span> 미제출 (마감 지남)</span>
                    <span><span style="display:inline-block;width:14px;height:14px;background:#f1f5f9;border:1px dashed #e2e8f0;border-radius:3px;"></span> 미도래</span>
                </div>
                <div id="grassGrid">
                    <!-- JS에서 렌더링 -->
                </div>
            </div>

            <!-- 과제 상세 기록 -->
            <div class="task-table-container">
                <div class="task-table-title">
                    <span><i class="fas fa-tasks" style="color:#3b82f6;"></i> 과제별 상세 기록</span>
                    <span id="taskCount" style="font-size:13px; color:#94a3b8; font-weight:500;">-</span>
                </div>
                <div class="task-filter-bar">
                    <select id="taskWeekFilter" onchange="applyTaskFilters()">
                        <option value="">전체 주차</option>
                    </select>
                    <select id="taskTypeFilter" onchange="applyTaskFilters()">
                        <option value="">전체 과제</option>
                        <option value="reading">Reading</option>
                        <option value="listening">Listening</option>
                        <option value="writing">Writing</option>
                        <option value="speaking">Speaking</option>
                        <option value="vocab">Vocab</option>
                        <option value="intro-book">입문서</option>
                    </select>
                    <select id="taskStatusFilter" onchange="applyTaskFilters()">
                        <option value="">전체 상태</option>
                        <option value="fraud">⚠️ Fraud만</option>
                        <option value="normal">✅ 정상만</option>
                    </select>
                </div>
                <div style="overflow-x: auto;">
                    <table class="admin-table" id="taskTable">
                        <thead>
                            <tr>
                                <th>날짜</th>
                                <th>요일</th>
                                <th>과제</th>
                                <th>1차 점수</th>
                                <th>인증률</th>
                                <th>제출시간</th>
                                <th>노트</th>
                                <th>상태</th>
                            </tr>
                        </thead>
                        <tbody id="taskTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="taskEmpty" style="display:none; text-align:center; padding:40px 20px; color:#94a3b8;">
                    <i class="fas fa-inbox" style="font-size:36px; margin-bottom:12px;"></i>
                    <p>과제 기록이 없습니다</p>
                </div>
            </div>

            <!-- 오답노트 섹션 -->
            <div class="notes-container">
                <div class="section-title">
                    <i class="fas fa-sticky-note" style="color:#f59e0b;"></i>
                    오답노트 & 메모 모아보기
                </div>
                <div id="notesList">
                    <!-- JS에서 렌더링 -->
                </div>
                <div id="notesEmpty" style="display:none; text-align:center; padding:32px; color:#94a3b8;">
                    <i class="fas fa-file-alt" style="font-size:32px; margin-bottom:8px;"></i>
                    <p>작성된 오답노트/메모가 없습니다</p>
                </div>
            </div>

            <!-- 과제 진행상태 관리 -->
            <div class="progress-mgmt-container">
                <div class="section-title">
                    <i class="fas fa-tools" style="color:#6366f1;"></i>
                    과제 진행상태 관리
                    <span id="progressCount" style="font-size:12px; color:#94a3b8; font-weight:400; margin-left:8px;"></span>
                </div>
                <div id="progressLoading" style="text-align:center; padding:20px; color:#94a3b8; display:none;">
                    <i class="fas fa-spinner fa-spin"></i> 불러오는 중...
                </div>
                <div id="progressTableWrap" style="overflow-x:auto;">
                    <table class="progress-table" id="progressTable">
                        <thead>
                            <tr>
                                <th></th>
                                <th>과제 종류</th>
                                <th>모듈</th>
                                <th>차수</th>
                                <th>진행률</th>
                                <th>상태</th>
                                <th>마지막 수정</th>
                                <th>액션</th>
                            </tr>
                        </thead>
                        <tbody id="progressTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="progressEmpty" style="display:none; text-align:center; padding:32px; color:#94a3b8;">
                    <i class="fas fa-check-circle" style="font-size:32px; margin-bottom:8px;"></i>
                    <p>중간저장 기록이 없습니다</p>
                </div>
            </div>

            <!-- 주간체크 데이터 수집 -->
            <div class="weekly-check-container">
                <div class="section-title">
                    <i class="fas fa-clipboard-check" style="color:#7c3aed;"></i>
                    주간체크 데이터 수집
                </div>
                <div class="task-filter-bar">
                    <select id="weeklyCheckWeek" onchange="generateWeeklyCheckData()">
                        <!-- JS에서 렌더링 -->
                    </select>
                </div>
                <div class="copy-area" id="weeklyCheckData">
                    주차를 선택하면 데이터가 생성됩니다.
                </div>
                <button class="btn-copy" id="btnCopy" onclick="copyWeeklyCheck()">
                    <i class="fas fa-copy"></i> 클립보드에 복사
                </button>
            </div>

        </div><!-- /detailContent -->
    </div>

    <!-- 오답노트 모달 -->
    <div class="modal-overlay" id="noteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalNoteTitle">오답노트 / 메모</h3>
                <button class="modal-close" onclick="closeNoteModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalNoteBody">-</div>
            <div class="modal-meta" id="modalNoteMeta">-</div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/supabase-config.js"></script>
    <script src="js/admin-utils.js"></script>
    <script src="js/admin-study-detail.js"></script>
</body>
</html>
